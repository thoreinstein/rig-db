{"id":"rig_db-3nj","title":"CLI History Commands","description":"## Overview\nImplement the CLI commands for recording shell history: start (pre-exec) and end (post-exec) commands that communicate with the daemon.\n\n## Context (from ADR)\n- rig history start -- \"command\" - called by pre-exec hook\n- rig history end --id \u003cUUID\u003e --exit \u003cCODE\u003e - called by post-exec hook\n- Generates UUID v7 locally (time-ordered)\n- Communicates with daemon via Unix Domain Socket\n- Falls back to temp write-ahead log if daemon unreachable\n\n## Scope\n- UUID v7 generation\n- `rig history start` command implementation\n- `rig history end` command implementation\n- Daemon socket communication\n- Fallback write-ahead log for daemon failures\n\n## Acceptance Criteria\n- [ ] UUID v7 generated correctly (time-ordered)\n- [ ] `rig history start` sends JSON to daemon and prints UUID\n- [ ] `rig history end` sends completion data to daemon\n- [ ] Commands complete in \u003c10ms (non-blocking to shell)\n- [ ] Fallback log created when daemon unreachable\n- [ ] Graceful handling of daemon restart mid-command\n\n## Dependencies\nDepends on: SQLite Integration, Daemon Architecture epics\nBlocks: Shell Hooks epic","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-31T13:45:38.62382-05:00","created_by":"myers","updated_at":"2026-01-31T20:39:19.636942-05:00","closed_at":"2026-01-31T20:39:19.636942-05:00","close_reason":"All child tasks completed - CLI history commands fully implemented","dependencies":[{"issue_id":"rig_db-3nj","depends_on_id":"rig_db-mm5","type":"blocks","created_at":"2026-01-31T13:46:45.078081-05:00","created_by":"myers"},{"issue_id":"rig_db-3nj","depends_on_id":"rig_db-7sz","type":"blocks","created_at":"2026-01-31T13:46:45.137411-05:00","created_by":"myers"}]}
{"id":"rig_db-3nj.1","title":"Implement UUID v7 generation","description":"## Overview\nImplement UUID v7 generation for time-ordered history record identifiers.\n\n## Technical Details\n- UUID v7: Time-ordered UUID (RFC 9562)\n- Format: timestamp (48-bit ms) + version (4-bit) + random (12-bit) + variant (2-bit) + random (62-bit)\n- Must be monotonic within same millisecond\n\n## Implementation Notes\n- Use std.time for timestamp\n- Use std.crypto.random for random bits\n- Consider implementing monotonic counter for same-ms generation\n- Return as 36-char string (8-4-4-4-12 format)\n\n## Acceptance Criteria\n- [ ] Generates valid UUID v7 format\n- [ ] Time-ordered (later UUIDs sort after earlier)\n- [ ] Unique even when called rapidly\n- [ ] Parses timestamp from UUID correctly\n- [ ] Performance: \u003c1μs per generation","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T13:48:00.485316-05:00","created_by":"myers","updated_at":"2026-01-31T14:51:30.6422-05:00","closed_at":"2026-01-31T14:51:30.6422-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-3nj.1","depends_on_id":"rig_db-3nj","type":"parent-child","created_at":"2026-01-31T13:48:00.485873-05:00","created_by":"myers"}]}
{"id":"rig_db-3nj.2","title":"Implement 'rig history start' command","description":"## Overview\nImplement the pre-exec hook command that records command start.\n\n## Usage\n```bash\nrig history start -- \"ls -la\"\n# Outputs: \u003cuuid\u003e\n```\n\n## Behavior\n1. Generate UUID v7\n2. Capture: timestamp, command, cwd, session, hostname\n3. Send to daemon via socket\n4. Print UUID to stdout (for shell to capture)\n\n## Implementation Notes\n- Must be fast (\u003c10ms total)\n- Get cwd from std.fs.cwd()\n- Get hostname from std.os or /etc/hostname\n- Session UUID: generate once per shell session, store in env var\n\n## Acceptance Criteria\n- [ ] Generates and prints UUID v7\n- [ ] Sends complete start message to daemon\n- [ ] Captures accurate cwd and hostname\n- [ ] Completes in \u003c10ms\n- [ ] Non-zero exit if daemon communication fails (but still prints UUID)\n- [ ] Handles special characters in command","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T13:48:05.912415-05:00","created_by":"myers","updated_at":"2026-01-31T20:39:10.729768-05:00","closed_at":"2026-01-31T20:39:10.729768-05:00","close_reason":"Fully implemented with tests","dependencies":[{"issue_id":"rig_db-3nj.2","depends_on_id":"rig_db-3nj","type":"parent-child","created_at":"2026-01-31T13:48:05.912868-05:00","created_by":"myers"},{"issue_id":"rig_db-3nj.2","depends_on_id":"rig_db-3nj.1","type":"blocks","created_at":"2026-01-31T13:48:24.471883-05:00","created_by":"myers"},{"issue_id":"rig_db-3nj.2","depends_on_id":"rig_db-3nj.4","type":"blocks","created_at":"2026-01-31T13:48:25.02511-05:00","created_by":"myers"}]}
{"id":"rig_db-3nj.3","title":"Implement 'rig history end' command","description":"## Overview\nImplement the post-exec hook command that records command completion.\n\n## Usage\n```bash\nrig history end --id \u003cuuid\u003e --exit \u003ccode\u003e\n```\n\n## Behavior\n1. Calculate duration (current time - UUID v7 timestamp)\n2. Send end message with id, exit code, duration to daemon\n3. Exit silently on success\n\n## Implementation Notes\n- Extract timestamp from UUID v7 for duration calculation\n- Duration in nanoseconds (per ADR schema)\n- Fire-and-forget: don't block shell on daemon response\n\n## Acceptance Criteria\n- [ ] Calculates accurate duration from UUID timestamp\n- [ ] Sends complete end message to daemon\n- [ ] Handles missing --id gracefully (warning, no crash)\n- [ ] Completes in \u003c5ms\n- [ ] Fire-and-forget: returns immediately after send\n- [ ] Works even if start was never recorded","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T13:48:10.329249-05:00","created_by":"myers","updated_at":"2026-01-31T20:39:10.736-05:00","closed_at":"2026-01-31T20:39:10.736-05:00","close_reason":"Fully implemented with tests","dependencies":[{"issue_id":"rig_db-3nj.3","depends_on_id":"rig_db-3nj","type":"parent-child","created_at":"2026-01-31T13:48:10.329805-05:00","created_by":"myers"},{"issue_id":"rig_db-3nj.3","depends_on_id":"rig_db-3nj.1","type":"blocks","created_at":"2026-01-31T13:48:25.511765-05:00","created_by":"myers"},{"issue_id":"rig_db-3nj.3","depends_on_id":"rig_db-3nj.4","type":"blocks","created_at":"2026-01-31T13:48:26.059902-05:00","created_by":"myers"}]}
{"id":"rig_db-3nj.4","title":"Implement daemon socket client","description":"## Overview\nImplement the client-side socket communication for CLI commands.\n\n## Technical Details\n- Connect to daemon's Unix Domain Socket\n- Send length-prefixed JSON messages\n- Handle connection failures gracefully\n- Trigger daemon spawn if not running\n\n## Implementation Notes\n- Use std.net.StreamClient for UDS connection\n- Implement retry logic with backoff\n- If socket doesn't exist, spawn daemon and retry\n- Configurable timeout for connection\n\n## Acceptance Criteria\n- [ ] Connects to daemon socket successfully\n- [ ] Sends length-prefixed JSON correctly\n- [ ] Receives and parses response\n- [ ] Spawns daemon if socket missing\n- [ ] Retries on transient failures\n- [ ] Returns error after max retries exhausted","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T13:48:13.89529-05:00","created_by":"myers","updated_at":"2026-01-31T14:51:30.64386-05:00","closed_at":"2026-01-31T14:51:30.64386-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-3nj.4","depends_on_id":"rig_db-3nj","type":"parent-child","created_at":"2026-01-31T13:48:13.896361-05:00","created_by":"myers"},{"issue_id":"rig_db-3nj.4","depends_on_id":"rig_db-7sz.2","type":"blocks","created_at":"2026-01-31T13:48:23.846398-05:00","created_by":"myers"}]}
{"id":"rig_db-3nj.5","title":"Implement fallback write-ahead log","description":"## Overview\nWhen daemon is unreachable, write to a temporary file that daemon processes on next startup.\n\n## Technical Details\n- Location: $XDG_DATA_HOME/rig/pending.jsonl\n- Format: One JSON message per line (JSONL)\n- Daemon reads and processes on startup, then truncates\n\n## Implementation Notes\n- Append-only writes (fast, crash-safe with fsync)\n- Include all fields needed for history record\n- Daemon startup: read pending.jsonl, process, truncate\n- Handle concurrent writes (flock or atomic append)\n\n## Acceptance Criteria\n- [ ] Writes to pending.jsonl when daemon unreachable\n- [ ] File format is valid JSONL\n- [ ] Daemon processes pending records on startup\n- [ ] No data loss on crash during write\n- [ ] Concurrent CLI invocations don't corrupt file\n- [ ] File cleaned up after processing","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T13:48:19.009776-05:00","created_by":"myers","updated_at":"2026-01-31T20:39:10.739664-05:00","closed_at":"2026-01-31T20:39:10.739664-05:00","close_reason":"Fully implemented with tests","dependencies":[{"issue_id":"rig_db-3nj.5","depends_on_id":"rig_db-3nj","type":"parent-child","created_at":"2026-01-31T13:48:19.010304-05:00","created_by":"myers"},{"issue_id":"rig_db-3nj.5","depends_on_id":"rig_db-3nj.4","type":"blocks","created_at":"2026-01-31T13:48:26.611716-05:00","created_by":"myers"}]}
{"id":"rig_db-7sz","title":"Daemon Architecture","description":"## Overview\nImplement the lightweight background daemon (rig-daemon) that owns exclusive write access to the SQLite database.\n\n## Context (from ADR)\n- Owns exclusive write lock to SQLite database\n- Listens on Unix Domain Socket (AF_UNIX)\n- Buffers write requests in memory to prevent shell blocking\n- Launched on demand via socket activation pattern\n- Uses length-prefixed JSON protocol: \u003cu32 length\u003e\u003cjson payload\u003e\n\n## Scope\n- Unix Domain Socket server implementation\n- Length-prefixed JSON protocol parsing\n- In-memory write queue/buffering\n- SQLite write path with exclusive lock\n- Socket activation / on-demand lifecycle\n\n## Acceptance Criteria\n- [ ] Daemon listens on Unix Domain Socket\n- [ ] Protocol correctly parses length-prefixed JSON\n- [ ] Write queue buffers requests without blocking clients\n- [ ] SQLite writes committed reliably\n- [ ] Daemon spawns on-demand when socket accessed\n- [ ] Graceful shutdown with queue flush\n- [ ] No memory leaks (verified with GPA)\n\n## Dependencies\nDepends on: SQLite Integration epic\nBlocks: CLI History Commands epic","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-31T13:45:38.514273-05:00","created_by":"myers","updated_at":"2026-01-31T14:47:26.671356-05:00","closed_at":"2026-01-31T14:47:26.671356-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-7sz","depends_on_id":"rig_db-mm5","type":"blocks","created_at":"2026-01-31T13:46:45.017138-05:00","created_by":"myers"}]}
{"id":"rig_db-7sz.1","title":"Implement Unix Domain Socket server","description":"## Overview\nCreate the core UDS server that listens for connections from the CLI.\n\n## Technical Details\n- Transport: Unix Domain Sockets (AF_UNIX)\n- Socket location: $XDG_RUNTIME_DIR/rig.sock or /tmp/rig-$UID.sock\n- Non-blocking I/O for multiple client handling\n\n## Implementation Notes\n- Use std.net.StreamServer for UDS\n- Consider using std.event or libxev for event loop\n- Handle SIGTERM/SIGINT for graceful shutdown\n- Remove stale socket file on startup\n\n## Acceptance Criteria\n- [ ] Server binds to Unix Domain Socket\n- [ ] Accepts multiple concurrent connections\n- [ ] Handles client disconnects gracefully\n- [ ] Removes socket on clean shutdown\n- [ ] Cleans up stale socket from crashed process\n- [ ] Non-blocking - doesn't hang on slow clients","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T13:47:26.168564-05:00","created_by":"myers","updated_at":"2026-01-31T14:33:01.327297-05:00","closed_at":"2026-01-31T14:33:01.327297-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-7sz.1","depends_on_id":"rig_db-7sz","type":"parent-child","created_at":"2026-01-31T13:47:26.169794-05:00","created_by":"myers"}]}
{"id":"rig_db-7sz.2","title":"Implement length-prefixed JSON protocol","description":"## Overview\nImplement the IPC protocol for CLI-daemon communication.\n\n## Protocol (from ADR)\n- Structure: \u003cu32 length\u003e\u003cjson payload\u003e\n- Length is 4 bytes, little-endian\n- JSON payload follows immediately\n\n## Message Types\n```json\n// Start command\n{ \"type\": \"start\", \"id\": \"uuid\", \"cmd\": \"ls -la\", \"ts\": 1234567890, \"cwd\": \"/home/user\", \"session\": \"uuid\", \"hostname\": \"host\" }\n\n// End command  \n{ \"type\": \"end\", \"id\": \"uuid\", \"exit\": 0, \"duration\": 15000000 }\n```\n\n## Implementation Notes\n- Use std.json for parsing/serialization\n- Validate message schema before processing\n- Return acknowledgment or error response\n\n## Acceptance Criteria\n- [ ] Correctly reads length prefix\n- [ ] Parses JSON payload with std.json\n- [ ] Validates required fields per message type\n- [ ] Returns success/error response to client\n- [ ] Handles malformed messages without crashing\n- [ ] Handles partial reads (buffering)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T13:47:31.29311-05:00","created_by":"myers","updated_at":"2026-01-31T14:40:22.949665-05:00","closed_at":"2026-01-31T14:40:22.949665-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-7sz.2","depends_on_id":"rig_db-7sz","type":"parent-child","created_at":"2026-01-31T13:47:31.293638-05:00","created_by":"myers"},{"issue_id":"rig_db-7sz.2","depends_on_id":"rig_db-7sz.1","type":"blocks","created_at":"2026-01-31T13:47:50.2983-05:00","created_by":"myers"}]}
{"id":"rig_db-7sz.3","title":"Implement in-memory write queue","description":"## Overview\nBuffer write requests in memory to ensure CLI never blocks on disk I/O.\n\n## Technical Details\n- Queue incoming write requests\n- Process queue asynchronously\n- Batch writes for efficiency\n- Handle queue overflow gracefully\n\n## Implementation Notes\n- Use std.ArrayList or ring buffer for queue\n- Consider memory limits (configurable max queue size)\n- Persist queue to disk on shutdown for crash recovery\n- Log warnings when queue grows large\n\n## Acceptance Criteria\n- [ ] Incoming requests queued immediately (non-blocking)\n- [ ] Queue processed in FIFO order\n- [ ] Batch writes when possible (multiple inserts per transaction)\n- [ ] Memory usage bounded by configurable limit\n- [ ] Queue persisted on graceful shutdown\n- [ ] Metrics available (queue depth, write latency)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T13:47:35.67034-05:00","created_by":"myers","updated_at":"2026-01-31T14:43:55.167239-05:00","closed_at":"2026-01-31T14:43:55.167239-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-7sz.3","depends_on_id":"rig_db-7sz","type":"parent-child","created_at":"2026-01-31T13:47:35.670816-05:00","created_by":"myers"},{"issue_id":"rig_db-7sz.3","depends_on_id":"rig_db-7sz.2","type":"blocks","created_at":"2026-01-31T13:47:50.696934-05:00","created_by":"myers"}]}
{"id":"rig_db-7sz.4","title":"Implement SQLite exclusive write path","description":"## Overview\nDaemon owns exclusive write access to SQLite - implement the write path that processes queued requests.\n\n## Technical Details\n- Single write connection with exclusive lock\n- Process \"start\" messages: INSERT new record\n- Process \"end\" messages: UPDATE with duration/exit\n- Handle orphaned starts (no matching end)\n\n## Implementation Notes\n- Use BEGIN IMMEDIATE for write transactions\n- Batch multiple writes in single transaction\n- Handle SQLITE_BUSY with exponential backoff\n- Periodic cleanup of incomplete records\n\n## Acceptance Criteria\n- [ ] Exclusive write lock maintained\n- [ ] Start messages create new history records\n- [ ] End messages update existing records\n- [ ] Transactions committed reliably\n- [ ] Handles concurrent read connections (WAL)\n- [ ] Orphan cleanup runs periodically","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T13:47:39.92199-05:00","created_by":"myers","updated_at":"2026-01-31T14:47:20.580727-05:00","closed_at":"2026-01-31T14:47:20.580727-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-7sz.4","depends_on_id":"rig_db-7sz","type":"parent-child","created_at":"2026-01-31T13:47:39.92255-05:00","created_by":"myers"},{"issue_id":"rig_db-7sz.4","depends_on_id":"rig_db-7sz.3","type":"blocks","created_at":"2026-01-31T13:47:51.236399-05:00","created_by":"myers"},{"issue_id":"rig_db-7sz.4","depends_on_id":"rig_db-mm5.5","type":"blocks","created_at":"2026-01-31T13:47:51.94203-05:00","created_by":"myers"}]}
{"id":"rig_db-7sz.5","title":"Implement socket activation lifecycle","description":"## Overview\nDaemon launches on-demand when CLI attempts socket connection, following socket activation pattern.\n\n## Technical Details\n- CLI spawns daemon if socket doesn't exist\n- Daemon creates socket and signals ready\n- Idle timeout: shutdown after N minutes of inactivity\n- PID file for process management\n\n## Implementation Notes\n- Use fork/exec or std.ChildProcess for daemon spawn\n- Detach from terminal (setsid, redirect stdio)\n- Write PID to $XDG_RUNTIME_DIR/rig.pid\n- Implement idle timer that resets on activity\n\n## Acceptance Criteria\n- [ ] Daemon spawns when socket accessed and not running\n- [ ] Only one daemon instance runs (PID file locking)\n- [ ] Daemon detaches from terminal properly\n- [ ] Auto-shutdown after configurable idle period\n- [ ] Clean startup even after unclean shutdown\n- [ ] CLI waits appropriately for daemon ready","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T13:47:45.092493-05:00","created_by":"myers","updated_at":"2026-01-31T14:40:22.951347-05:00","closed_at":"2026-01-31T14:40:22.951347-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-7sz.5","depends_on_id":"rig_db-7sz","type":"parent-child","created_at":"2026-01-31T13:47:45.093806-05:00","created_by":"myers"},{"issue_id":"rig_db-7sz.5","depends_on_id":"rig_db-7sz.1","type":"blocks","created_at":"2026-01-31T13:47:52.567438-05:00","created_by":"myers"}]}
{"id":"rig_db-g1j","title":"TUI Search Interface","description":"## Overview\nImplement the terminal user interface for searching and selecting commands from history.\n\n## Context (from ADR)\n- Read Path: connects directly to SQLite (ReadOnly mode) for instant search\n- Bypasses daemon IPC for queries to reduce latency\n- Uses zig-clap for argument parsing\n- Consider vaxis or raw termios handling\n\n## Scope\n- Direct SQLite read connection (ReadOnly mode)\n- Terminal raw mode / TUI framework selection\n- Search query input handling\n- Results display with scrolling\n- Command selection and output\n\n## Acceptance Criteria\n- [ ] Opens SQLite in ReadOnly mode (no daemon needed)\n- [ ] Responsive search (\u003c50ms for typical queries)\n- [ ] Fuzzy matching or prefix search supported\n- [ ] Results sorted by timestamp (most recent first)\n- [ ] Arrow key navigation through results\n- [ ] Enter to select and output command\n- [ ] Ctrl+C to cancel\n- [ ] Works in common terminal emulators\n\n## Dependencies\nDepends on: SQLite Integration epic\nCan be developed in parallel with Shell Hooks","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-31T13:45:48.481256-05:00","created_by":"myers","updated_at":"2026-01-31T14:44:06.344459-05:00","closed_at":"2026-01-31T14:44:06.344459-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-g1j","depends_on_id":"rig_db-mm5","type":"blocks","created_at":"2026-01-31T13:46:45.248119-05:00","created_by":"myers"}]}
{"id":"rig_db-g1j.1","title":"Implement SQLite read-only connection","description":"## Overview\nTUI bypasses daemon and connects directly to SQLite in read-only mode for minimal latency.\n\n## Technical Details\n- Open database with SQLITE_OPEN_READONLY flag\n- No locking conflicts with daemon's write connection (WAL mode)\n- Connection pooling not needed (single-threaded TUI)\n\n## Implementation Notes\n- Reuse XDG path resolution from SQLite epic\n- Verify WAL mode allows concurrent reads\n- Handle case where database doesn't exist yet\n- Implement query timeout for responsiveness\n\n## Acceptance Criteria\n- [ ] Opens database in read-only mode\n- [ ] No conflicts with daemon writes\n- [ ] Graceful handling of missing database\n- [ ] Query execution \u003c50ms for typical searches\n- [ ] Connection closed cleanly on TUI exit","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-31T13:49:35.170075-05:00","created_by":"myers","updated_at":"2026-01-31T14:33:01.328896-05:00","closed_at":"2026-01-31T14:33:01.328896-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-g1j.1","depends_on_id":"rig_db-g1j","type":"parent-child","created_at":"2026-01-31T13:49:35.170688-05:00","created_by":"myers"},{"issue_id":"rig_db-g1j.1","depends_on_id":"rig_db-mm5.5","type":"blocks","created_at":"2026-01-31T13:49:56.696925-05:00","created_by":"myers"}]}
{"id":"rig_db-g1j.2","title":"Implement terminal raw mode and input handling","description":"## Overview\nSet up terminal for TUI: raw mode, key capture, and screen management.\n\n## Technical Details\n- Enter raw mode (disable line buffering, echo)\n- Capture keystrokes including special keys (arrows, Ctrl+*)\n- Restore terminal state on exit (including crashes)\n- Handle terminal resize (SIGWINCH)\n\n## Implementation Notes\n- Consider using vaxis library (pure Zig TUI)\n- Alternative: raw termios with std.os\n- Register signal handlers for cleanup\n- Support common terminal emulators (iTerm2, Terminal.app, gnome-terminal, etc.)\n\n## Acceptance Criteria\n- [ ] Enters raw mode successfully\n- [ ] Captures arrow keys, Enter, Escape, Ctrl+C\n- [ ] Terminal restored on normal exit\n- [ ] Terminal restored on Ctrl+C\n- [ ] Terminal restored after panic/crash\n- [ ] Handles window resize","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-31T13:49:40.081813-05:00","created_by":"myers","updated_at":"2026-01-31T14:33:01.330019-05:00","closed_at":"2026-01-31T14:33:01.330019-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-g1j.2","depends_on_id":"rig_db-g1j","type":"parent-child","created_at":"2026-01-31T13:49:40.082289-05:00","created_by":"myers"}]}
{"id":"rig_db-g1j.3","title":"Implement search query and filtering","description":"## Overview\nImplement the search logic that filters history based on user input.\n\n## Search Features\n- Prefix matching (default)\n- Substring matching\n- Filter by directory (cwd)\n- Filter by exit code (success/failure)\n- Filter by time range\n\n## Implementation Notes\n- Use SQL LIKE for basic matching\n- Consider FTS5 for fuzzy matching (future enhancement)\n- Cache recent queries for responsiveness\n- Limit results (e.g., top 1000) for performance\n\n## Acceptance Criteria\n- [ ] Prefix search works (\"ls\" matches \"ls -la\")\n- [ ] Substring search available (\"la\" matches \"ls -la\")\n- [ ] Filter by current directory\n- [ ] Filter by exit code (--success, --fail)\n- [ ] Results sorted by timestamp (most recent first)\n- [ ] Unique commands option (deduplicate)\n- [ ] Query executes in \u003c50ms","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-31T13:49:45.170919-05:00","created_by":"myers","updated_at":"2026-01-31T14:40:22.952553-05:00","closed_at":"2026-01-31T14:40:22.952553-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-g1j.3","depends_on_id":"rig_db-g1j","type":"parent-child","created_at":"2026-01-31T13:49:45.171429-05:00","created_by":"myers"},{"issue_id":"rig_db-g1j.3","depends_on_id":"rig_db-g1j.1","type":"blocks","created_at":"2026-01-31T13:49:57.363758-05:00","created_by":"myers"}]}
{"id":"rig_db-g1j.4","title":"Implement results display and selection","description":"## Overview\nDisplay search results in a scrollable list with selection highlighting.\n\n## UI Layout\n```\n\u003e search query here_\n───────────────────\n  ls -la                              2 min ago\n\u003e git commit -m \"fix\"                 5 min ago  ← selected\n  npm install                         1 hour ago\n  ...\n[↑↓ navigate] [Enter select] [Esc cancel]\n```\n\n## Features\n- Scrollable list with visible selection\n- Show command, relative time, maybe exit indicator\n- Syntax highlighting for commands (optional)\n- Status bar with keybinding hints\n\n## Implementation Notes\n- Render incrementally as user types\n- Handle long commands (truncate with ellipsis)\n- Consider showing context (cwd, hostname) on detail line\n\n## Acceptance Criteria\n- [ ] Results displayed in scrollable list\n- [ ] Selection clearly highlighted\n- [ ] Up/Down arrows navigate selection\n- [ ] Page Up/Down for fast scrolling\n- [ ] Enter outputs selected command\n- [ ] Escape exits without output\n- [ ] Long commands truncated elegantly\n- [ ] Relative timestamps displayed","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-31T13:49:51.668446-05:00","created_by":"myers","updated_at":"2026-01-31T14:43:55.168853-05:00","closed_at":"2026-01-31T14:43:55.168853-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-g1j.4","depends_on_id":"rig_db-g1j","type":"parent-child","created_at":"2026-01-31T13:49:51.668918-05:00","created_by":"myers"},{"issue_id":"rig_db-g1j.4","depends_on_id":"rig_db-g1j.2","type":"blocks","created_at":"2026-01-31T13:49:58.18088-05:00","created_by":"myers"},{"issue_id":"rig_db-g1j.4","depends_on_id":"rig_db-g1j.3","type":"blocks","created_at":"2026-01-31T13:49:58.522068-05:00","created_by":"myers"}]}
{"id":"rig_db-mm5","title":"SQLite Integration","description":"## Overview\nSet up SQLite as the storage engine for shell history, including build system integration, schema creation, and basic database operations.\n\n## Context (from ADR)\n- Engine: SQLite with WAL mode\n- Location: XDG Base Directory spec (~/.local/share/rig/history.db)\n- Zig can import SQLite's C headers directly via @cImport\n\n## Scope\n- Configure build.zig to link SQLite\n- Implement database initialization following XDG spec\n- Create history table schema per ADR\n- Implement read/write operations for history records\n\n## Acceptance Criteria\n- [ ] build.zig successfully links SQLite via @cImport\n- [ ] Database created at XDG-compliant path\n- [ ] WAL mode enabled by default\n- [ ] History table schema matches ADR specification\n- [ ] Basic insert/query operations working\n- [ ] All tests pass with `zig build test`\n\n## Dependencies\nThis epic is foundational - blocks Daemon, CLI, and TUI epics.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-31T13:45:38.42954-05:00","created_by":"myers","updated_at":"2026-01-31T14:24:50.500014-05:00","closed_at":"2026-01-31T14:24:50.500014-05:00","close_reason":"Closed"}
{"id":"rig_db-mm5.1","title":"Configure build.zig for SQLite linkage","description":"## Overview\nSet up build.zig to link SQLite using Zig's @cImport capability for direct C header import.\n\n## Technical Details\n- Use Zig's @cImport to import sqlite3.h\n- Configure build.zig to link against system SQLite or bundle SQLite amalgamation\n- Ensure cross-compilation support is maintained\n\n## Implementation Notes\n- Consider bundling SQLite amalgamation (sqlite3.c) for portability\n- Set appropriate compile flags for SQLite (SQLITE_THREADSAFE=0 for single-threaded daemon)\n\n## Acceptance Criteria\n- [ ] build.zig successfully compiles with SQLite\n- [ ] Can call basic SQLite functions (sqlite3_open, sqlite3_close)\n- [ ] Cross-compilation still works (test with `zig build -Dtarget=x86_64-linux`)\n- [ ] `zig build test` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T13:46:56.144398-05:00","created_by":"myers","updated_at":"2026-01-31T14:15:02.852594-05:00","closed_at":"2026-01-31T14:15:02.852594-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-mm5.1","depends_on_id":"rig_db-mm5","type":"parent-child","created_at":"2026-01-31T13:46:56.14569-05:00","created_by":"myers"}]}
{"id":"rig_db-mm5.2","title":"Implement XDG Base Directory path resolution","description":"## Overview\nImplement XDG Base Directory specification compliance for database location.\n\n## Technical Details\n- Primary: $XDG_DATA_HOME/rig/history.db\n- Fallback: ~/.local/share/rig/history.db\n- Create directory if not exists\n\n## Implementation Notes\n- Use std.os.getenv for environment variable lookup\n- Use std.fs for directory creation\n- Handle permission errors gracefully\n\n## Acceptance Criteria\n- [ ] Respects $XDG_DATA_HOME when set\n- [ ] Falls back to ~/.local/share/rig when not set\n- [ ] Creates parent directories if missing\n- [ ] Returns appropriate errors for permission issues\n- [ ] Works on macOS and Linux","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T13:46:59.396031-05:00","created_by":"myers","updated_at":"2026-01-31T14:15:02.855499-05:00","closed_at":"2026-01-31T14:15:02.855499-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-mm5.2","depends_on_id":"rig_db-mm5","type":"parent-child","created_at":"2026-01-31T13:46:59.39657-05:00","created_by":"myers"}]}
{"id":"rig_db-mm5.3","title":"Implement database initialization with WAL mode","description":"## Overview\nCreate database initialization routine that opens/creates the SQLite database with WAL mode enabled.\n\n## Technical Details\n- Open database at XDG path\n- Enable WAL mode: PRAGMA journal_mode=WAL\n- Set appropriate pragmas for performance\n- Handle first-run vs existing database\n\n## Implementation Notes\nRecommended pragmas:\n- journal_mode=WAL\n- synchronous=NORMAL (good balance of safety/speed)\n- foreign_keys=ON\n- busy_timeout=5000\n\n## Acceptance Criteria\n- [ ] Creates new database if not exists\n- [ ] Opens existing database without data loss\n- [ ] WAL mode confirmed active\n- [ ] Pragmas set correctly\n- [ ] Returns errors for corruption/lock issues","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T13:47:03.182747-05:00","created_by":"myers","updated_at":"2026-01-31T14:16:38.350997-05:00","closed_at":"2026-01-31T14:16:38.350997-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-mm5.3","depends_on_id":"rig_db-mm5","type":"parent-child","created_at":"2026-01-31T13:47:03.183216-05:00","created_by":"myers"},{"issue_id":"rig_db-mm5.3","depends_on_id":"rig_db-mm5.1","type":"blocks","created_at":"2026-01-31T13:47:17.899856-05:00","created_by":"myers"},{"issue_id":"rig_db-mm5.3","depends_on_id":"rig_db-mm5.2","type":"blocks","created_at":"2026-01-31T13:47:18.240795-05:00","created_by":"myers"}]}
{"id":"rig_db-mm5.4","title":"Create history table schema","description":"## Overview\nImplement the history table schema as specified in the ADR.\n\n## Schema (from ADR)\n```sql\nCREATE TABLE history (\n    id TEXT PRIMARY KEY,        -- UUID v7 (time-ordered)\n    timestamp INTEGER NOT NULL, -- Nanoseconds since epoch\n    duration INTEGER NOT NULL,  -- Nanoseconds\n    exit INTEGER NOT NULL,      -- Exit code\n    command TEXT NOT NULL,      -- The command string\n    cwd TEXT NOT NULL,          -- Working directory\n    session TEXT NOT NULL,      -- Session UUID\n    hostname TEXT NOT NULL,     -- Hostname\n    deleted_at INTEGER          -- Soft delete timestamp\n);\n```\n\n## Implementation Notes\n- Create indexes for common queries (timestamp, command, cwd)\n- Consider FTS5 virtual table for full-text search (future)\n- Implement schema versioning for migrations\n\n## Acceptance Criteria\n- [ ] Table created with all columns per ADR\n- [ ] Primary key on id column\n- [ ] Index on timestamp for recent queries\n- [ ] Schema version tracking implemented\n- [ ] Idempotent creation (safe to run multiple times)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T13:47:07.65557-05:00","created_by":"myers","updated_at":"2026-01-31T14:18:22.598248-05:00","closed_at":"2026-01-31T14:18:22.598248-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-mm5.4","depends_on_id":"rig_db-mm5","type":"parent-child","created_at":"2026-01-31T13:47:07.656095-05:00","created_by":"myers"},{"issue_id":"rig_db-mm5.4","depends_on_id":"rig_db-mm5.3","type":"blocks","created_at":"2026-01-31T13:47:18.774773-05:00","created_by":"myers"}]}
{"id":"rig_db-mm5.5","title":"Implement history record CRUD operations","description":"## Overview\nImplement the data access layer for history records: insert, update, query, and soft delete.\n\n## Operations Needed\n1. **Insert**: Create new history record (from start command)\n2. **Update**: Set duration/exit code (from end command)\n3. **Query**: Search by command text, cwd, time range\n4. **Soft Delete**: Set deleted_at timestamp\n\n## Implementation Notes\n- Use prepared statements for performance\n- Implement connection pooling (or single connection for daemon)\n- Handle SQLite busy/locked errors with retry\n\n## Acceptance Criteria\n- [ ] Insert creates valid history record\n- [ ] Update modifies only specified fields\n- [ ] Query returns results sorted by timestamp desc\n- [ ] Soft delete sets deleted_at, doesn't remove row\n- [ ] All operations use prepared statements\n- [ ] Proper error handling for constraint violations\n- [ ] Unit tests cover all operations","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-31T13:47:11.890813-05:00","created_by":"myers","updated_at":"2026-01-31T14:24:45.978591-05:00","closed_at":"2026-01-31T14:24:45.978591-05:00","close_reason":"Closed","dependencies":[{"issue_id":"rig_db-mm5.5","depends_on_id":"rig_db-mm5","type":"parent-child","created_at":"2026-01-31T13:47:11.891337-05:00","created_by":"myers"},{"issue_id":"rig_db-mm5.5","depends_on_id":"rig_db-mm5.4","type":"blocks","created_at":"2026-01-31T13:47:19.275159-05:00","created_by":"myers"}]}
{"id":"rig_db-tv3","title":"Shell Hooks Integration","description":"## Overview\nImplement shell initialization commands that generate hook scripts for Zsh and Bash to capture command history.\n\n## Context (from ADR)\n- Hooks: Generates shell scripts (rig init zsh, etc.)\n- Handles start/end events via pre-exec and post-exec hooks\n- Port the Zsh/Bash scripts from atuin\n\n## Scope\n- `rig init zsh` command\n- `rig init bash` command  \n- Pre-exec hook script generation\n- Post-exec hook script generation\n- Installation instructions output\n\n## Acceptance Criteria\n- [ ] `rig init zsh` outputs valid Zsh hook script\n- [ ] `rig init bash` outputs valid Bash hook script\n- [ ] Hooks correctly invoke `rig history start` on pre-exec\n- [ ] Hooks correctly invoke `rig history end` on post-exec\n- [ ] Exit codes captured and passed correctly\n- [ ] Command duration calculated accurately\n- [ ] Scripts handle edge cases (empty commands, special chars)\n\n## Dependencies\nDepends on: CLI History Commands epic","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-31T13:45:43.294218-05:00","created_by":"myers","updated_at":"2026-02-01T09:22:28.30955-05:00","closed_at":"2026-02-01T09:22:28.30955-05:00","close_reason":"Shell hooks integration complete - rig init zsh/bash commands implemented with full edge case handling","dependencies":[{"issue_id":"rig_db-tv3","depends_on_id":"rig_db-3nj","type":"blocks","created_at":"2026-01-31T13:46:45.1928-05:00","created_by":"myers"}]}
{"id":"rig_db-tv3.1","title":"Implement 'rig init zsh' command","description":"## Overview\nGenerate Zsh shell initialization script that integrates rig history hooks.\n\n## Usage\n```bash\n# In ~/.zshrc:\neval \"$(rig init zsh)\"\n```\n\n## Output Script Must Include\n- preexec hook: capture command, call `rig history start`\n- precmd hook: call `rig history end` with exit code\n- RIG_SESSION environment variable (UUID for session tracking)\n- Keybinding for history search (Ctrl+R override)\n\n## Implementation Notes\n- Study atuin's zsh integration for reference\n- Use zsh's preexec/precmd hook arrays\n- Handle edge cases: empty commands, multiline commands\n- Preserve existing hooks (append, don't replace)\n\n## Acceptance Criteria\n- [ ] Output is valid Zsh script\n- [ ] preexec captures command text correctly\n- [ ] precmd captures exit code correctly\n- [ ] Duration calculated accurately\n- [ ] Session UUID persists for shell lifetime\n- [ ] Ctrl+R launches rig search (when TUI ready)\n- [ ] Doesn't break existing shell functionality\n- [ ] Works with oh-my-zsh, prezto, etc.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-31T13:49:19.437233-05:00","created_by":"myers","updated_at":"2026-02-01T09:21:58.422348-05:00","closed_at":"2026-02-01T09:21:58.422348-05:00","close_reason":"Implemented with preexec/precmd hooks for zsh and DEBUG trap/PROMPT_COMMAND for bash","dependencies":[{"issue_id":"rig_db-tv3.1","depends_on_id":"rig_db-tv3","type":"parent-child","created_at":"2026-01-31T13:49:19.438158-05:00","created_by":"myers"},{"issue_id":"rig_db-tv3.1","depends_on_id":"rig_db-3nj.2","type":"blocks","created_at":"2026-01-31T13:49:25.104193-05:00","created_by":"myers"},{"issue_id":"rig_db-tv3.1","depends_on_id":"rig_db-3nj.3","type":"blocks","created_at":"2026-01-31T13:49:25.689946-05:00","created_by":"myers"}]}
{"id":"rig_db-tv3.2","title":"Implement 'rig init bash' command","description":"## Overview\nGenerate Bash shell initialization script that integrates rig history hooks.\n\n## Usage\n```bash\n# In ~/.bashrc:\neval \"$(rig init bash)\"\n```\n\n## Output Script Must Include\n- DEBUG trap: capture command before execution\n- PROMPT_COMMAND: call `rig history end` after execution\n- RIG_SESSION environment variable\n- Keybinding for history search (Ctrl+R override)\n\n## Implementation Notes\n- Bash doesn't have preexec natively - use DEBUG trap\n- PROMPT_COMMAND runs before each prompt\n- Track command start time in variable\n- Handle edge cases: empty input, Ctrl+C interrupted\n\n## Acceptance Criteria\n- [ ] Output is valid Bash script (POSIX-compatible where possible)\n- [ ] DEBUG trap captures command correctly\n- [ ] PROMPT_COMMAND records completion\n- [ ] Exit code captured accurately\n- [ ] Works with Bash 4.0+ and 5.x\n- [ ] Compatible with bash-preexec if installed\n- [ ] Doesn't break existing PROMPT_COMMAND","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-31T13:49:21.105608-05:00","created_by":"myers","updated_at":"2026-02-01T09:21:58.425519-05:00","closed_at":"2026-02-01T09:21:58.425519-05:00","close_reason":"Implemented with preexec/precmd hooks for zsh and DEBUG trap/PROMPT_COMMAND for bash","dependencies":[{"issue_id":"rig_db-tv3.2","depends_on_id":"rig_db-tv3","type":"parent-child","created_at":"2026-01-31T13:49:21.106067-05:00","created_by":"myers"},{"issue_id":"rig_db-tv3.2","depends_on_id":"rig_db-3nj.2","type":"blocks","created_at":"2026-01-31T13:49:26.207666-05:00","created_by":"myers"},{"issue_id":"rig_db-tv3.2","depends_on_id":"rig_db-3nj.3","type":"blocks","created_at":"2026-01-31T13:49:26.73237-05:00","created_by":"myers"}]}
{"id":"rig_db-tv3.3","title":"Implement hook script edge case handling","description":"## Overview\nEnsure shell hooks handle all edge cases robustly without disrupting user shell experience.\n\n## Edge Cases to Handle\n1. Empty commands (just pressing Enter)\n2. Multiline commands (heredocs, continuations)\n3. Commands with special characters (quotes, $, backticks)\n4. Ctrl+C interrupted commands\n5. Background jobs (\u0026)\n6. Subshells and command substitution\n7. Very long commands (\u003e64KB)\n8. Commands that change directory\n\n## Implementation Notes\n- Test each case manually in real shells\n- Add guards to prevent double-recording\n- Ensure hook failures don't break shell\n- Silent failures: log to file, don't print errors\n\n## Acceptance Criteria\n- [ ] Empty commands not recorded\n- [ ] Multiline commands recorded as single entry\n- [ ] Special characters preserved correctly\n- [ ] Ctrl+C records with exit code 130\n- [ ] Background jobs handled appropriately\n- [ ] Hook errors logged, not printed\n- [ ] Long commands truncated gracefully\n- [ ] No duplicate history entries","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-31T13:49:21.193259-05:00","created_by":"myers","updated_at":"2026-02-01T09:22:18.884236-05:00","closed_at":"2026-02-01T09:22:18.884236-05:00","close_reason":"Edge cases handled in init scripts: empty cmd check, preexec_done flag, proper quoting, silent failures via 2\u003e/dev/null, background execution","dependencies":[{"issue_id":"rig_db-tv3.3","depends_on_id":"rig_db-tv3","type":"parent-child","created_at":"2026-01-31T13:49:21.193728-05:00","created_by":"myers"},{"issue_id":"rig_db-tv3.3","depends_on_id":"rig_db-tv3.1","type":"blocks","created_at":"2026-01-31T13:49:27.307042-05:00","created_by":"myers"},{"issue_id":"rig_db-tv3.3","depends_on_id":"rig_db-tv3.2","type":"blocks","created_at":"2026-01-31T13:49:27.834064-05:00","created_by":"myers"}]}
